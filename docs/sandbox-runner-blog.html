<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox Runner ä»£ç è¯¦è§£ | æ²™ç®±æ‰§è¡Œå™¨æ·±åº¦è§£æ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #fefefe;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-code: #1e293b;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-indigo: #6366f1;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-violet: #8b5cf6;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Serif SC', Georgia, serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 17px;
            min-height: 100vh;
        }

        /* Subtle grid pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header */
        header {
            position: relative;
            padding: 5rem 2rem 4rem;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #faf5ff 100%);
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 30% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 100%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Decorative shapes */
        header::after {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border-radius: 50%;
            filter: blur(60px);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-20px, 20px); }
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-indigo);
            background: white;
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            margin-bottom: 1.5rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            box-shadow: var(--shadow-sm);
        }

        .badge::before {
            content: 'ğŸ“¦';
        }

        h1 {
            font-family: 'Inter', sans-serif;
            font-size: clamp(2.5rem, 6vw, 3.5rem);
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-indigo) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            line-height: 1.7;
        }

        /* Main layout */
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            max-width: 1400px;
            margin: 0 auto;
            gap: 4rem;
            padding: 3rem 2rem;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Table of Contents */
        .toc {
            position: sticky;
            top: 2rem;
            height: fit-content;
        }

        @media (max-width: 1024px) {
            .toc {
                position: relative;
                top: 0;
                background: var(--bg-secondary);
                padding: 1.5rem;
                border-radius: 16px;
                border: 1px solid var(--border-color);
            }
        }

        .toc-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        .toc-list {
            list-style: none;
            border-left: 2px solid var(--border-color);
        }

        .toc-item {
            padding: 0.5rem 0 0.5rem 1rem;
            border-left: 2px solid transparent;
            margin-left: -2px;
            transition: all 0.2s ease;
        }

        .toc-item:hover {
            border-left-color: var(--accent-blue);
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05), transparent);
        }

        .toc-item.active {
            border-left-color: var(--accent-indigo);
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.08), transparent);
        }

        .toc-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
            transition: color 0.2s ease;
        }

        .toc-item:hover .toc-link,
        .toc-item.active .toc-link {
            color: var(--accent-indigo);
        }

        /* Content */
        article {
            max-width: 800px;
        }

        section {
            margin-bottom: 4rem;
            scroll-margin-top: 2rem;
        }

        h2 {
            font-family: 'Inter', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 1.5rem;
            background: linear-gradient(180deg, var(--accent-indigo), var(--accent-blue));
            border-radius: 2px;
        }

        h3 {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 2rem 0 1rem;
        }

        p {
            margin-bottom: 1.25rem;
            color: var(--text-secondary);
        }

        strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Architecture Diagram Box */
        .diagram-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        }

        .diagram-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-indigo);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .diagram-title::before {
            content: 'â—†';
            font-size: 0.6rem;
        }

        .architecture {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .arch-box {
            background: white;
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1.25rem;
            margin: 1rem 0;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .arch-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .arch-box.host {
            border-color: var(--accent-emerald);
        }

        .arch-box-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .arch-box.host .arch-box-title {
            color: var(--accent-emerald);
        }

        .arch-box-title::before {
            content: 'â—';
            font-size: 0.6rem;
        }

        .arch-box ul {
            list-style: none;
            padding-left: 1rem;
        }

        .arch-box li {
            position: relative;
            padding-left: 1.25rem;
            margin: 0.4rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .arch-box li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .arch-box.host li::before {
            color: var(--accent-emerald);
        }

        .pipe-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 1.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .pipe {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .pipe-arrow {
            color: var(--accent-amber);
            font-size: 1.2rem;
            animation: bounce 1.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }

        .pipe-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Code blocks */
        .code-block {
            position: relative;
            margin: 1.5rem 0;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-code);
            box-shadow: var(--shadow-lg);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .code-lang {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-violet);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .copy-btn {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #94a3b8;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .copy-btn.copied {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        pre {
            margin: 0;
            padding: 1.25rem;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            color: #e2e8f0;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Inline code */
        p code, li code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.9em;
            color: var(--accent-rose);
            border: 1px solid var(--border-color);
        }

        /* Syntax highlighting */
        .keyword { color: #c084fc; }
        .string { color: #86efac; }
        .comment { color: #64748b; font-style: italic; }
        .function { color: #60a5fa; }
        .number { color: #fbbf24; }
        .variable { color: #f8fafc; }
        .decorator { color: #fbbf24; }
        .builtin { color: #f472b6; }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
        }

        th {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(99, 102, 241, 0.03);
        }

        /* Info boxes */
        .info-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.05));
            border-left: 4px solid var(--accent-blue);
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 12px 12px 0;
        }

        .info-box.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(251, 191, 36, 0.05));
            border-left-color: var(--accent-amber);
        }

        .info-box strong {
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .info-box strong::before {
            content: 'ğŸ’¡';
        }

        .info-box.warning strong {
            color: var(--accent-amber);
        }

        .info-box.warning strong::before {
            content: 'âš ï¸';
        }

        .info-box p {
            margin: 0;
            font-size: 0.95rem;
        }

        /* Mermaid diagrams */
        .mermaid-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Timeline */
        .timeline {
            position: relative;
            margin: 2rem 0;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-emerald), var(--accent-violet));
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            padding: 1rem 0 1rem 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 1.25rem;
            width: 12px;
            height: 12px;
            background: var(--accent-blue);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }

        .timeline-item:nth-child(2)::before {
            background: var(--accent-emerald);
        }

        .timeline-item:nth-child(3)::before {
            background: var(--accent-violet);
        }

        .timeline-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .timeline-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Security grid */
        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .security-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .security-card:hover {
            border-color: var(--accent-emerald);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .security-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .security-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .security-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* Flow diagram */
        .flow-diagram {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            overflow-x: auto;
        }

        .flow-diagram pre {
            color: var(--text-secondary);
            background: transparent;
            padding: 0;
            font-size: 0.75rem;
            line-height: 1.8;
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border-color);
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            background: var(--bg-secondary);
        }

        footer a {
            color: var(--accent-indigo);
            text-decoration: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Animation on scroll */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Decorative elements */
        .section-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-indigo), var(--accent-blue));
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 8px;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <span class="badge">Technical Deep Dive</span>
            <h1>Sandbox Runner ä»£ç è¯¦è§£</h1>
            <p class="subtitle">æ·±å…¥è§£ææ²™ç®±ä»£ç æ‰§è¡Œå™¨ï¼šåœ¨éš”ç¦»ç¯å¢ƒä¸­å®‰å…¨æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œæ”¯æŒé€šè¿‡ IPC è°ƒç”¨å¤–éƒ¨å·¥å…·çš„å®Œæ•´å®ç°</p>
        </div>
    </header>

    <div class="container">
        <aside class="toc">
            <div class="toc-title">ç›®å½•å¯¼èˆª</div>
            <ul class="toc-list">
                <li class="toc-item"><a href="#architecture" class="toc-link">æ¶æ„æ¦‚è§ˆ</a></li>
                <li class="toc-item"><a href="#ipc-protocol" class="toc-link">IPC åè®®æ ‡è®°</a></li>
                <li class="toc-item"><a href="#tool-call" class="toc-link">å·¥å…·è°ƒç”¨æœºåˆ¶</a></li>
                <li class="toc-item"><a href="#dynamic-tools" class="toc-link">åŠ¨æ€åˆ›å»ºå·¥å…·å‡½æ•°</a></li>
                <li class="toc-item"><a href="#output-capture" class="toc-link">è¾“å‡ºæ•è·</a></li>
                <li class="toc-item"><a href="#code-execution" class="toc-link">ç”¨æˆ·ä»£ç æ‰§è¡Œæ ¸å¿ƒ</a></li>
                <li class="toc-item"><a href="#main-entry" class="toc-link">ä¸»å…¥å£</a></li>
                <li class="toc-item"><a href="#flow" class="toc-link">å®Œæ•´é€šä¿¡æµç¨‹</a></li>
                <li class="toc-item"><a href="#security" class="toc-link">å®‰å…¨è€ƒè™‘</a></li>
                <li class="toc-item"><a href="#sequence" class="toc-link">æµç¨‹å›¾è§£</a></li>
                <li class="toc-item"><a href="#runner-script" class="toc-link">Runner Script è¯¦è§£</a></li>
                <li class="toc-item"><a href="#unbuffered-io" class="toc-link">æ— ç¼“å†² I/O æœºåˆ¶</a></li>
                <li class="toc-item"><a href="#parallel-tools" class="toc-link">å¹¶è¡Œå·¥å…·è°ƒç”¨</a></li>
                <li class="toc-item"><a href="#execution-modes" class="toc-link">æ‰§è¡Œæ¨¡å¼</a></li>
            </ul>
        </aside>

        <article>
            <section id="architecture" class="fade-in">
                <h2><span class="section-number">1</span>æ¶æ„æ¦‚è§ˆ</h2>
                <p>è¿™æ˜¯ä¸€ä¸ª<strong>æ²™ç®±ä»£ç æ‰§è¡Œå™¨</strong>ï¼Œç”¨äºåœ¨éš”ç¦»ç¯å¢ƒä¸­å®‰å…¨æ‰§è¡Œç”¨æˆ·ä»£ç ï¼ŒåŒæ—¶æ”¯æŒé€šè¿‡ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚æ•´ä¸ªç³»ç»Ÿé‡‡ç”¨åŒè¿›ç¨‹æ¶æ„ï¼Œé€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºè¿›è¡Œæ¶ˆæ¯ä¼ é€’ã€‚</p>

                <div class="diagram-box">
                    <div class="diagram-title">ç³»ç»Ÿæ¶æ„å›¾</div>
                    <div class="architecture">
                        <div class="arch-box host">
                            <div class="arch-box-title">ä¸»è¿›ç¨‹ (Host)</div>
                            <ul>
                                <li>å¯åŠ¨æ²™ç®±å­è¿›ç¨‹</li>
                                <li>é€šè¿‡ stdin å‘é€ä»£ç å’Œå·¥å…·è°ƒç”¨ç»“æœ</li>
                                <li>é€šè¿‡ stdout/stderr æ¥æ”¶æ‰§è¡Œç»“æœå’Œå·¥å…·è°ƒç”¨è¯·æ±‚</li>
                            </ul>
                        </div>

                        <div class="pipe-indicator">
                            <div class="pipe">
                                <span class="pipe-arrow">â†“</span>
                                <span class="pipe-label">stdin</span>
                            </div>
                            <div class="pipe">
                                <span class="pipe-arrow">â†‘</span>
                                <span class="pipe-label">stdout</span>
                            </div>
                            <div class="pipe">
                                <span class="pipe-arrow">â†‘</span>
                                <span class="pipe-label">stderr</span>
                            </div>
                        </div>

                        <div class="arch-box">
                            <div class="arch-box-title">æ²™ç®±å­è¿›ç¨‹ (Sandbox)</div>
                            <ul>
                                <li>æ¥æ”¶å¹¶æ‰§è¡Œç”¨æˆ·ä»£ç </li>
                                <li>æ‹¦æˆªå·¥å…·è°ƒç”¨ï¼Œè½¬å‘ç»™ä¸»è¿›ç¨‹</li>
                                <li>è¿”å›æ‰§è¡Œç»“æœ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="ipc-protocol" class="fade-in">
                <h2><span class="section-number">2</span>IPC åè®®æ ‡è®°</h2>
                <p>ä¸ºäº†åœ¨æ–‡æœ¬æµä¸­å‡†ç¡®åˆ†éš”ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼Œç³»ç»Ÿå®šä¹‰äº†ä¸€ç»„<strong>æ¶ˆæ¯è¾¹ç•Œæ ‡è®°</strong>ã€‚è¿™äº›æ ‡è®°ç¡®ä¿ä¸»è¿›ç¨‹å’Œæ²™ç®±å­è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«å’Œè§£ææ¶ˆæ¯ã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="variable">IPC_TOOL_CALL_START</span> = <span class="string">"__PTC_TOOL_CALL__"</span>
<span class="variable">IPC_TOOL_CALL_END</span> = <span class="string">"__PTC_END_CALL__"</span>
<span class="variable">IPC_TOOL_RESULT_START</span> = <span class="string">"__PTC_TOOL_RESULT__"</span>
<span class="variable">IPC_TOOL_RESULT_END</span> = <span class="string">"__PTC_END_RESULT__"</span>
<span class="variable">IPC_CODE_OUTPUT_START</span> = <span class="string">"__PTC_OUTPUT__"</span>
<span class="variable">IPC_CODE_OUTPUT_END</span> = <span class="string">"__PTC_END_OUTPUT__"</span></code></pre>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>æ ‡è®°</th>
                                <th>ç”¨é€”</th>
                                <th>æ–¹å‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>TOOL_CALL</code></td>
                                <td>æ²™ç®±è¯·æ±‚è°ƒç”¨å·¥å…·</td>
                                <td>æ²™ç®± â†’ ä¸»è¿›ç¨‹ (stderr)</td>
                            </tr>
                            <tr>
                                <td><code>TOOL_RESULT</code></td>
                                <td>ä¸»è¿›ç¨‹è¿”å›å·¥å…·ç»“æœ</td>
                                <td>ä¸»è¿›ç¨‹ â†’ æ²™ç®± (stdin)</td>
                            </tr>
                            <tr>
                                <td><code>CODE_OUTPUT</code></td>
                                <td>ä»£ç æ‰§è¡Œæœ€ç»ˆç»“æœ</td>
                                <td>æ²™ç®± â†’ ä¸»è¿›ç¨‹ (stdout)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="tool-call" class="fade-in">
                <h2><span class="section-number">3</span>å·¥å…·è°ƒç”¨æœºåˆ¶</h2>

                <h3>3.1 å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚</h3>
                <p>å½“æ²™ç®±ä¸­çš„ä»£ç éœ€è¦è°ƒç”¨å¤–éƒ¨å·¥å…·æ—¶ï¼Œä¼šé€šè¿‡ <code>stderr</code> å‘é€è¯·æ±‚ã€‚ä½¿ç”¨ stderr è€Œé stdout æ˜¯ä¸ºäº†é¿å…ä¸ç”¨æˆ·ä»£ç çš„ <code>print()</code> è¾“å‡ºæ··æ·†ã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_send_tool_call</span>(tool_name: <span class="builtin">str</span>, arguments: <span class="builtin">dict</span>) -> <span class="builtin">str</span>:
    <span class="string">"""å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚åˆ°ä¸»è¿›ç¨‹"""</span>
    call_id = <span class="builtin">str</span>(uuid.uuid4())  <span class="comment"># ç”Ÿæˆå”¯ä¸€IDç”¨äºåŒ¹é…è¯·æ±‚/å“åº”</span>
    request = {
        <span class="string">"call_id"</span>: call_id,
        <span class="string">"tool_name"</span>: tool_name,
        <span class="string">"arguments"</span>: arguments
    }
    <span class="comment"># å‘é€åˆ° stderrï¼ˆé¿å…ä¸ print è¾“å‡ºæ··æ·†ï¼‰</span>
    message = <span class="string">f"{IPC_TOOL_CALL_START}{json.dumps(request)}{IPC_TOOL_CALL_END}"</span>
    <span class="builtin">print</span>(message, file=sys.stderr, flush=<span class="keyword">True</span>)
    <span class="keyword">return</span> call_id</code></pre>
                </div>

                <div class="info-box">
                    <strong>ä¸ºä»€ä¹ˆç”¨ stderrï¼Ÿ</strong>
                    <p>stdout ç”¨äºç”¨æˆ·ä»£ç çš„ <code>print()</code> è¾“å‡ºï¼Œstderr ä¸“é—¨ç”¨äºç³»ç»Ÿçº§ IPC é€šä¿¡ï¼Œè¿™æ ·å¯ä»¥å®Œå…¨é¿å…æ¶ˆæ¯æ··æ·†ã€‚</p>
                </div>

                <h3>3.2 æ¥æ”¶å·¥å…·è°ƒç”¨ç»“æœ</h3>
                <p>å‘é€è¯·æ±‚åï¼Œæ²™ç®±ä¼šé˜»å¡ç­‰å¾…ä¸»è¿›ç¨‹é€šè¿‡ stdin è¿”å›ç»“æœã€‚é€šè¿‡ <code>call_id</code> ç¡®ä¿è¯·æ±‚å’Œå“åº”çš„æ­£ç¡®åŒ¹é…ã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_receive_tool_result</span>(call_id: <span class="builtin">str</span>, timeout: <span class="builtin">float</span> = <span class="number">30.0</span>) -> Any:
    <span class="string">"""ä»ä¸»è¿›ç¨‹æ¥æ”¶å·¥å…·è°ƒç”¨ç»“æœ"""</span>
    <span class="keyword">while</span> <span class="keyword">True</span>:
        line = sys.stdin.readline()  <span class="comment"># é˜»å¡è¯»å–</span>
        <span class="keyword">if not</span> line:
            <span class="keyword">raise</span> <span class="builtin">RuntimeError</span>(<span class="string">f"EOF while waiting for tool result: {call_id}"</span>)

        line = line.strip()
        <span class="keyword">if</span> IPC_TOOL_RESULT_START <span class="keyword">in</span> line <span class="keyword">and</span> IPC_TOOL_RESULT_END <span class="keyword">in</span> line:
            <span class="comment"># è§£ææ¶ˆæ¯</span>
            start = line.find(IPC_TOOL_RESULT_START) + <span class="builtin">len</span>(IPC_TOOL_RESULT_START)
            end = line.find(IPC_TOOL_RESULT_END)
            result_json = line[start:end]
            result = json.loads(result_json)

            <span class="comment"># æ£€æŸ¥ call_id åŒ¹é…</span>
            <span class="keyword">if</span> result.get(<span class="string">"call_id"</span>) == call_id:
                <span class="keyword">if</span> result.get(<span class="string">"error"</span>):
                    <span class="keyword">raise</span> <span class="builtin">RuntimeError</span>(<span class="string">f"Tool error: {result['error']}"</span>)
                <span class="keyword">return</span> result.get(<span class="string">"result"</span>)</code></pre>
                </div>
            </section>

            <section id="dynamic-tools" class="fade-in">
                <h2><span class="section-number">4</span>åŠ¨æ€åˆ›å»ºå·¥å…·å‡½æ•°</h2>
                <p>ç³»ç»Ÿæ ¹æ® <code>TOOLS_INFO</code> é…ç½®åŠ¨æ€ç”Ÿæˆå·¥å…·å‡½æ•°ã€‚æ¯ä¸ªå·¥å…·å‡½æ•°éƒ½æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œä½¿ç”¨é—­åŒ…æ•è·å·¥å…·åç§°ï¼Œå¹¶é€šè¿‡ <code>run_in_executor</code> å°†é˜»å¡çš„ stdin è¯»å–æ”¾åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_create_tool_function</span>(tool_name: <span class="builtin">str</span>):
    <span class="string">"""åˆ›å»ºå·¥å…·è°ƒç”¨å‡½æ•°"""</span>
    <span class="keyword">async def</span> <span class="function">tool_func</span>(**kwargs) -> Any:
        <span class="comment"># 1. å‘é€è°ƒç”¨è¯·æ±‚</span>
        call_id = _send_tool_call(tool_name, kwargs)

        <span class="comment"># 2. åœ¨çº¿ç¨‹æ± ä¸­ç­‰å¾…ç»“æœï¼ˆé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ï¼‰</span>
        loop = asyncio.get_event_loop()
        result = <span class="keyword">await</span> loop.run_in_executor(
            <span class="keyword">None</span>,  <span class="comment"># ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± </span>
            <span class="keyword">lambda</span>: _receive_tool_result(call_id)
        )
        <span class="keyword">return</span> result

    <span class="keyword">return</span> tool_func

<span class="comment"># æ ¹æ® TOOLS_INFO åŠ¨æ€ç”Ÿæˆæ‰€æœ‰å·¥å…·å‡½æ•°</span>
_tool_functions = {}
<span class="keyword">for</span> tool_info <span class="keyword">in</span> TOOLS_INFO:
    tool_name = tool_info[<span class="string">"name"</span>]
    _tool_functions[tool_name] = _create_tool_function(tool_name)</code></pre>
                </div>

                <div class="info-box">
                    <strong>å…³é”®è®¾è®¡è¦ç‚¹</strong>
                    <p>ä½¿ç”¨é—­åŒ…æ•è· <code>tool_name</code>ï¼Œ<code>run_in_executor</code> å°†é˜»å¡çš„ stdin è¯»å–æ”¾åˆ°çº¿ç¨‹æ± ï¼Œé¿å…é˜»å¡ asyncio äº‹ä»¶å¾ªç¯ã€‚è¿™æ ·å¯ä»¥æ”¯æŒå¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆå¦‚ <code>asyncio.gather</code>ï¼‰ã€‚</p>
                </div>
            </section>

            <section id="output-capture" class="fade-in">
                <h2><span class="section-number">5</span>è¾“å‡ºæ•è·</h2>
                <p>ä¸ºäº†æ”¶é›†ç”¨æˆ·ä»£ç çš„æ‰€æœ‰ <code>print</code> è¾“å‡ºï¼Œç³»ç»Ÿå®ç°äº†ä¸€ä¸ªæ¨¡æ‹Ÿ <code>sys.stdout</code> æ¥å£çš„ç±»ï¼Œå°†æ‰€æœ‰è¾“å‡ºæ”¶é›†åˆ°å†…å­˜ä¸­ã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">class</span> <span class="function">OutputCapture</span>:
    <span class="string">"""æ•è· print è¾“å‡º"""</span>
    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self.outputs = []
        self._original_stdout = sys.stdout

    <span class="keyword">def</span> <span class="function">write</span>(self, text):
        <span class="keyword">if</span> text.strip():  <span class="comment"># å¿½ç•¥ç©ºè¡Œ</span>
            self.outputs.append(text)

    <span class="keyword">def</span> <span class="function">flush</span>(self):
        <span class="keyword">pass</span>

    <span class="keyword">def</span> <span class="function">get_output</span>(self) -> <span class="builtin">str</span>:
        <span class="keyword">return</span> <span class="string">""</span>.join(self.outputs)</code></pre>
                </div>
            </section>

            <section id="code-execution" class="fade-in">
                <h2><span class="section-number">6</span>ç”¨æˆ·ä»£ç æ‰§è¡Œæ ¸å¿ƒ</h2>
                <p>è¿™æ˜¯æ•´ä¸ªæ²™ç®±çš„æ ¸å¿ƒåŠŸèƒ½ï¼šæ¥æ”¶ç”¨æˆ·ä»£ç ï¼Œå‡†å¤‡æ‰§è¡Œç¯å¢ƒï¼Œæ³¨å…¥å·¥å…·å‡½æ•°ï¼Œç„¶ååœ¨éš”ç¦»çš„å‘½åç©ºé—´ä¸­æ‰§è¡Œä»£ç ã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">async def</span> <span class="function">execute_user_code</span>(code: <span class="builtin">str</span>) -> <span class="builtin">dict</span>:
    <span class="string">"""æ‰§è¡Œç”¨æˆ·ä»£ç """</span>

    <span class="comment"># 1. å‡†å¤‡æ‰§è¡Œç¯å¢ƒï¼ˆæ²™ç®± globalsï¼‰</span>
    exec_globals = {
        <span class="string">"__builtins__"</span>: __builtins__,
        <span class="string">"asyncio"</span>: asyncio,
        <span class="string">"json"</span>: json,
    }

    <span class="comment"># 2. æ³¨å…¥å·¥å…·å‡½æ•°ï¼ˆå¦‚ web_search, read_file ç­‰ï¼‰</span>
    <span class="keyword">for</span> name, func <span class="keyword">in</span> _tool_functions.items():
        exec_globals[name] = func

    <span class="comment"># 3. æ›¿æ¢ print å‡½æ•°ï¼Œæ•è·è¾“å‡º</span>
    output_capture = OutputCapture()
    exec_globals[<span class="string">"print"</span>] = <span class="keyword">lambda</span> *args, **kwargs: output_capture.write(
        <span class="string">" "</span>.join(<span class="builtin">str</span>(a) <span class="keyword">for</span> a <span class="keyword">in</span> args) + kwargs.get(<span class="string">"end"</span>, <span class="string">"\n"</span>)
    )

    <span class="comment"># 4. åŒ…è£…ç”¨æˆ·ä»£ç ä¸ºå¼‚æ­¥å‡½æ•°</span>
    indented_code = <span class="string">"\n"</span>.join(<span class="string">"    "</span> + line <span class="keyword">for</span> line <span class="keyword">in</span> code.split(<span class="string">"\n"</span>))
    wrapped_code = <span class="string">f"""
async def __user_main__():
{indented_code}
"""</span>

    <span class="comment"># 5. æ‰§è¡Œ</span>
    <span class="keyword">try</span>:
        <span class="builtin">exec</span>(<span class="builtin">compile</span>(wrapped_code, <span class="string">"&lt;user_code&gt;"</span>, <span class="string">"exec"</span>), exec_globals)
        <span class="keyword">await</span> exec_globals[<span class="string">"__user_main__"</span>]()
        <span class="keyword">return</span> {
            <span class="string">"success"</span>: <span class="keyword">True</span>,
            <span class="string">"output"</span>: output_capture.get_output(),
            <span class="string">"error"</span>: <span class="keyword">None</span>
        }
    <span class="keyword">except</span> <span class="builtin">Exception</span> <span class="keyword">as</span> e:
        <span class="keyword">return</span> {
            <span class="string">"success"</span>: <span class="keyword">False</span>,
            <span class="string">"output"</span>: output_capture.get_output(),
            <span class="string">"error"</span>: <span class="builtin">str</span>(e)
        }</code></pre>
                </div>

                <h3>ä»£ç åŒ…è£…ç¤ºä¾‹</h3>
                <p>ç”¨æˆ·ç¼–å†™çš„ä»£ç ä¼šè¢«è‡ªåŠ¨åŒ…è£…æˆå¼‚æ­¥å‡½æ•°ï¼Œä»¥ä¾¿æ”¯æŒ <code>await</code> è°ƒç”¨å·¥å…·ï¼š</p>

                <div class="diagram-box">
                    <div class="diagram-title">ä»£ç è½¬æ¢ç¤ºä¾‹</div>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center;">
                        <div class="code-block" style="margin: 0;">
                            <div class="code-header">
                                <span class="code-lang">ç”¨æˆ·ä»£ç </span>
                            </div>
                            <pre style="font-size: 0.8rem;"><code>result = <span class="keyword">await</span> web_search(query=<span class="string">"Python"</span>)
<span class="builtin">print</span>(result)</code></pre>
                        </div>
                        <div style="color: var(--accent-indigo); font-size: 1.5rem; font-weight: bold;">â†’</div>
                        <div class="code-block" style="margin: 0;">
                            <div class="code-header">
                                <span class="code-lang">åŒ…è£…å</span>
                            </div>
                            <pre style="font-size: 0.8rem;"><code><span class="keyword">async def</span> <span class="function">__user_main__</span>():
    result = <span class="keyword">await</span> web_search(query=<span class="string">"Python"</span>)
    <span class="builtin">print</span>(result)</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <section id="main-entry" class="fade-in">
                <h2><span class="section-number">7</span>ä¸»å…¥å£</h2>
                <p>ä¸»å…¥å£å‡½æ•°è´Ÿè´£ä» stdin è¯»å–ç”¨æˆ·ä»£ç ï¼ˆä½¿ç”¨è¾¹ç•Œæ ‡è®°ï¼‰ï¼Œæ‰§è¡Œä»£ç ï¼Œç„¶åå°†ç»“æœè¾“å‡ºåˆ° stdoutã€‚</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">main</span>():
    <span class="comment"># 1. ä» stdin è¯»å–ç”¨æˆ·ä»£ç ï¼ˆå¸¦è¾¹ç•Œæ ‡è®°ï¼‰</span>
    code_lines = []
    reading_code = <span class="keyword">False</span>

    <span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:
        line = line.rstrip(<span class="string">"\n"</span>)
        <span class="keyword">if</span> line == <span class="string">"__CODE_START__"</span>:
            reading_code = <span class="keyword">True</span>
            <span class="keyword">continue</span>
        <span class="keyword">elif</span> line == <span class="string">"__CODE_END__"</span>:
            <span class="keyword">break</span>
        <span class="keyword">elif</span> reading_code:
            code_lines.append(line)

    <span class="comment"># 2. æ‰§è¡Œä»£ç </span>
    code = <span class="string">"\n"</span>.join(code_lines)
    result = asyncio.run(execute_user_code(code))

    <span class="comment"># 3. è¾“å‡ºç»“æœï¼ˆå¸¦ IPC æ ‡è®°ï¼‰</span>
    <span class="builtin">print</span>(<span class="string">f"{IPC_CODE_OUTPUT_START}{json.dumps(result)}{IPC_CODE_OUTPUT_END}"</span>, flush=<span class="keyword">True</span>)</code></pre>
                </div>
            </section>

            <section id="flow" class="fade-in">
                <h2><span class="section-number">8</span>å®Œæ•´é€šä¿¡æµç¨‹</h2>
                <p>ä¸‹å›¾å±•ç¤ºäº†ä¸€æ¬¡å®Œæ•´çš„ä»£ç æ‰§è¡Œæµç¨‹ï¼ŒåŒ…æ‹¬å·¥å…·è°ƒç”¨çš„è¯·æ±‚-å“åº”è¿‡ç¨‹ï¼š</p>

                <div class="diagram-box flow-diagram">
                    <div class="diagram-title">é€šä¿¡æ—¶åºå›¾</div>
                    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.8;">
<span style="color: var(--accent-emerald); font-weight: 600;">ä¸»è¿›ç¨‹</span>                              <span style="color: var(--accent-blue); font-weight: 600;">æ²™ç®±å­è¿›ç¨‹</span>
   â”‚                                    â”‚
   â”‚â”€â”€â”€â”€ <span style="color: var(--accent-amber);">stdin:</span> __CODE_START__ â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚â”€â”€â”€â”€ <span style="color: var(--accent-amber);">stdin:</span> result = await ... â”€â”€â”€â”€â–¶â”‚
   â”‚â”€â”€â”€â”€ <span style="color: var(--accent-amber);">stdin:</span> __CODE_END__ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                    â”‚
   â”‚                                    â”‚ <span style="color: var(--text-muted);">(æ‰§è¡Œä»£ç ï¼Œé‡åˆ°å·¥å…·è°ƒç”¨)</span>
   â”‚                                    â”‚
   â”‚â—€â”€â”€ <span style="color: var(--accent-rose);">stderr:</span> {IPC_TOOL_CALL_START}  â”‚
   â”‚    <span style="color: var(--text-muted);">{"call_id":"xxx",</span>               â”‚
   â”‚     <span style="color: var(--text-muted);">"tool_name":"web_search",...}</span>  â”‚
   â”‚    <span style="color: var(--accent-rose);">{IPC_TOOL_CALL_END}</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                    â”‚
   â”‚ <span style="color: var(--text-muted);">(ä¸»è¿›ç¨‹æ‰§è¡ŒçœŸæ­£çš„å·¥å…·)</span>              â”‚ <span style="color: var(--text-muted);">(æ²™ç®±é˜»å¡ç­‰å¾…)</span>
   â”‚                                    â”‚
   â”‚â”€â”€â”€â”€ <span style="color: var(--accent-amber);">stdin:</span> {IPC_TOOL_RESULT_START}â–¶â”‚
   â”‚    <span style="color: var(--text-muted);">{"call_id":"xxx",</span>               â”‚
   â”‚     <span style="color: var(--text-muted);">"result":"..."}</span>                â”‚
   â”‚    <span style="color: var(--accent-amber);">{IPC_TOOL_RESULT_END}</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                    â”‚
   â”‚                                    â”‚ <span style="color: var(--text-muted);">(ç»§ç»­æ‰§è¡Œ)</span>
   â”‚                                    â”‚
   â”‚â—€â”€â”€ <span style="color: var(--accent-violet);">stdout:</span> {IPC_CODE_OUTPUT_START} â”‚
   â”‚    <span style="color: var(--text-muted);">{"success":true,</span>                â”‚
   â”‚     <span style="color: var(--text-muted);">"output":"..."}</span>                â”‚
   â”‚    <span style="color: var(--accent-violet);">{IPC_CODE_OUTPUT_END}</span> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                    â”‚</pre>
                </div>

                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-title">é˜¶æ®µä¸€ï¼šä»£ç ä¼ è¾“</div>
                        <div class="timeline-desc">ä¸»è¿›ç¨‹é€šè¿‡ stdin å°†ç”¨æˆ·ä»£ç å‘é€ç»™æ²™ç®±ï¼Œä½¿ç”¨ <code>__CODE_START__</code> å’Œ <code>__CODE_END__</code> æ ‡è®°è¾¹ç•Œ</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-title">é˜¶æ®µäºŒï¼šå·¥å…·è°ƒç”¨</div>
                        <div class="timeline-desc">æ²™ç®±æ‰§è¡Œä»£ç æ—¶é‡åˆ°å·¥å…·è°ƒç”¨ï¼Œé€šè¿‡ stderr å‘é€è¯·æ±‚ï¼Œç„¶åé˜»å¡ç­‰å¾…ç»“æœ</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-title">é˜¶æ®µä¸‰ï¼šç»“æœè¿”å›</div>
                        <div class="timeline-desc">ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œæ²™ç®±é€šè¿‡ stdout è¿”å›æœ€ç»ˆç»“æœï¼ˆåŒ…å«è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ï¼‰</div>
                    </div>
                </div>
            </section>

            <section id="security" class="fade-in">
                <h2><span class="section-number">9</span>å®‰å…¨è€ƒè™‘</h2>
                <p>æ²™ç®±æ‰§è¡Œå™¨å®ç°äº†å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œç¡®ä¿ç”¨æˆ·ä»£ç æ— æ³•å½±å“ä¸»ç³»ç»Ÿï¼š</p>

                <div class="security-grid">
                    <div class="security-card">
                        <div class="security-icon">ğŸ”’</div>
                        <div class="security-title">ä»£ç éš”ç¦»</div>
                        <div class="security-desc">åœ¨ç‹¬ç«‹çš„ Docker å®¹å™¨ä¸­æ‰§è¡Œï¼Œä¸ä¸»è¿›ç¨‹å®Œå…¨å†…å­˜éš”ç¦»</div>
                    </div>
                    <div class="security-card">
                        <div class="security-icon">ğŸ“</div>
                        <div class="security-title">è¾“å‡ºéš”ç¦»</div>
                        <div class="security-desc">æ›¿æ¢ print å‡½æ•°ï¼Œæ•è·å¹¶è¿‡æ»¤æ‰€æœ‰è¾“å‡ºå†…å®¹</div>
                    </div>
                    <div class="security-card">
                        <div class="security-icon">ğŸ”§</div>
                        <div class="security-title">å·¥å…·æ§åˆ¶</div>
                        <div class="security-desc">æ‰€æœ‰å·¥å…·è°ƒç”¨å¿…é¡»é€šè¿‡ IPCï¼Œç”±ä¸»è¿›ç¨‹å®¡æ ¸åæ‰§è¡Œ</div>
                    </div>
                    <div class="security-card">
                        <div class="security-icon">â±ï¸</div>
                        <div class="security-title">è¶…æ—¶æ§åˆ¶</div>
                        <div class="security-desc">è¿›ç¨‹çº§åˆ«çš„æ‰§è¡Œè¶…æ—¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯å’Œèµ„æºè€—å°½</div>
                    </div>
                    <div class="security-card">
                        <div class="security-icon">ğŸŒ</div>
                        <div class="security-title">ç½‘ç»œéš”ç¦»</div>
                        <div class="security-desc">å®¹å™¨é»˜è®¤ç¦ç”¨ç½‘ç»œè®¿é—®ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²</div>
                    </div>
                    <div class="security-card">
                        <div class="security-icon">ğŸ“¦</div>
                        <div class="security-title">èµ„æºé™åˆ¶</div>
                        <div class="security-desc">é™åˆ¶å†…å­˜ (256MB) å’Œ CPU (50%) ä½¿ç”¨é‡</div>
                    </div>
                </div>

                <div class="info-box warning">
                    <strong>å®‰å…¨æç¤º</strong>
                    <p>è¿™ä¸ªæ²™ç®±å¹¶éå®Œå…¨å®‰å…¨ï¼ˆæ¯”å¦‚æ²¡æœ‰é™åˆ¶ <code>__builtins__</code>ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦é…åˆ Docker å®‰å…¨é…ç½®ã€gVisor ç­‰å®¹å™¨æŠ€æœ¯å®ç°æ›´å¼ºçš„éš”ç¦»ã€‚</p>
                </div>
            </section>

            <section id="sequence" class="fade-in">
                <h2><span class="section-number">10</span>æµç¨‹å›¾è§£</h2>
                <p>ä»¥ä¸‹æ˜¯å®Œæ•´çš„ç³»ç»Ÿäº¤äº’æµç¨‹å›¾ï¼Œå±•ç¤ºäº†ä»ç”¨æˆ·è¯·æ±‚åˆ°æœ€ç»ˆå“åº”çš„å…¨è¿‡ç¨‹ï¼š</p>

                <div class="mermaid-wrapper">
                    <pre class="mermaid">
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Orch as Orchestrator
    participant Claude as Bedrock API
    participant Sandbox as æ²™ç®±æ‰§è¡Œå™¨
    participant Container as Dockerå®¹å™¨
    participant Tools as å·¥å…·æ³¨å†Œè¡¨

    rect rgb(240, 248, 255)
    Note over Tools: âš™ï¸ åˆå§‹åŒ–é˜¶æ®µ
    Note over Tools: å®¢æˆ·ç«¯æ³¨å†Œå·¥å…·
    end

    User->>Orch: å‘é€è¯·æ±‚
    Orch->>Claude: è°ƒç”¨APIï¼ˆé™„å¸¦å·¥å…·æ–‡æ¡£ï¼‰
    Claude->>Orch: è¿”å› execute_code è°ƒç”¨

    Orch->>Sandbox: æ‰§è¡Œä»£ç 
    Sandbox->>Container: åˆ›å»ºå®¹å™¨å¹¶è¿è¡Œä»£ç 

    Container->>Sandbox: IPCè¯·æ±‚ï¼šè°ƒç”¨å·¥å…·
    Sandbox->>Tools: æ‰§è¡Œå®é™…å·¥å…·å‡½æ•°
    Tools->>Sandbox: è¿”å›ç»“æœ
    Sandbox->>Container: è¿”å›å·¥å…·ç»“æœ

    Container->>Sandbox: ä»£ç æ‰§è¡Œå®Œæˆ
    Sandbox->>Orch: è¿”å›è¾“å‡º

    Orch->>Claude: å‘é€æ‰§è¡Œç»“æœ
    Claude->>Orch: ç”Ÿæˆæœ€ç»ˆå›å¤
    Orch->>User: è¿”å›ç­”æ¡ˆ
                    </pre>
                </div>

                <h3>è¯¦ç»†æµç¨‹å›¾</h3>
                <div class="mermaid-wrapper">
                    <pre class="mermaid">
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Registry as ToolRegistry
    participant Orch as Orchestrator
    participant Claude as Bedrock API
    participant Sandbox as SandboxExecutor
    participant Container as Docker Container
    participant Process as ä¸»è¿›ç¨‹IPC

    rect rgb(240, 248, 255)
        Note over User,Registry: 1. åˆå§‹åŒ–é˜¶æ®µ
        User->>Registry: æ³¨å†Œå·¥å…·å‡½æ•°
        Registry->>Registry: å­˜å‚¨å·¥å…·å‡½æ•°
        Registry->>Registry: ç”Ÿæˆ Schema
    end

    rect rgb(255, 248, 240)
        Note over User,Claude: 2. è¯·æ±‚å¤„ç†æµç¨‹
        User->>Orch: å‘é€ç”¨æˆ·è¯·æ±‚
        Orch->>Orch: æ„å»º System Prompt
        Orch->>Claude: è°ƒç”¨ Claude API
    end

    rect rgb(240, 255, 248)
        Note over Claude: 3. Claude å†³ç­–
        Claude->>Claude: åˆ†æè¯·æ±‚
        Claude->>Orch: è¿”å› tool_use
    end

    rect rgb(248, 240, 255)
        Note over Orch,Container: 4. æ²™ç®±æ‰§è¡Œ
        Orch->>Sandbox: execute(code)
        Sandbox->>Container: åˆ›å»º Docker å®¹å™¨
        Sandbox->>Container: æ³¨å…¥ runner.py
        Sandbox->>Container: å‘é€ä»£ç 
        Container->>Container: æ‰§è¡Œç”¨æˆ·ä»£ç 
    end

    rect rgb(255, 250, 240)
        Note over Container,Process: 5. IPC å·¥å…·è°ƒç”¨
        Container->>Process: stderr: å·¥å…·è°ƒç”¨è¯·æ±‚
        Process->>Registry: æ‰§è¡Œå·¥å…·
        Registry->>Process: è¿”å›ç»“æœ
        Process->>Container: stdin: å·¥å…·ç»“æœ
        Container->>Container: ç»§ç»­æ‰§è¡Œ
    end

    rect rgb(240, 250, 255)
        Note over Container,Orch: 6. æ‰§è¡Œå®Œæˆ
        Container->>Sandbox: stdout: æ‰§è¡Œç»“æœ
        Sandbox->>Orch: è¿”å›ç»“æœ
    end

    rect rgb(245, 248, 255)
        Note over Orch,User: 7. ç”Ÿæˆå›å¤
        Orch->>Claude: å‘é€ tool_result
        Claude->>Orch: è¿”å›æœ€ç»ˆå›å¤
        Orch->>User: è¿”å›ç­”æ¡ˆ
    end
                    </pre>
                </div>
            </section>

            <section id="runner-script" class="fade-in">
                <h2><span class="section-number">11</span>Runner Script è¯¦è§£</h2>
                <p>Runner Script æ˜¯æ²™ç®±æ‰§è¡Œçš„æ ¸å¿ƒè„šæœ¬ï¼Œç”±ä¸»è¿›ç¨‹åŠ¨æ€ç”Ÿæˆå¹¶æ³¨å…¥åˆ° Docker å®¹å™¨ä¸­ã€‚å®ƒè´Ÿè´£æ¥æ”¶ç”¨æˆ·ä»£ç ã€æ‹¦æˆªå·¥å…·è°ƒç”¨ã€ä¸ä¸»è¿›ç¨‹é€šä¿¡ã€‚</p>

                <h3>11.1 è„šæœ¬ç”Ÿæˆæœºåˆ¶</h3>
                <p>Runner Script æ˜¯ä¸€ä¸ª<strong>æ¨¡æ¿</strong>ï¼Œä¸»è¿›ç¨‹é€šè¿‡ <code>_get_runner_script()</code> æ–¹æ³•åŠ¨æ€ç”Ÿæˆï¼Œå°†å·¥å…·å®šä¹‰æ³¨å…¥è„šæœ¬ä¸­ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python - sandbox.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_get_runner_script</span>(self, tools: <span class="builtin">list</span>[<span class="builtin">dict</span>], loop_mode: <span class="builtin">bool</span> = <span class="keyword">False</span>) -> <span class="builtin">str</span>:
    <span class="string">"""
    Generate the runner script for sandbox execution.

    Args:
        tools: List of tool definitions (name, description, input_schema)
        loop_mode: Whether to run in loop mode for session reuse
    """</span>
    tools_json = json.dumps(tools)

    <span class="keyword">return</span> <span class="string">f'''#!/usr/bin/env python3
# IPC Protocol markers
IPC_TOOL_CALL_START = "{IPC_TOOL_CALL_START}"
...
# Tool definitions (åŠ¨æ€æ³¨å…¥)
TOOLS_INFO = {tools_json}
# Loop mode configuration
LOOP_MODE = {str(loop_mode)}
...
'''</span></code></pre>
                </div>

                <h3>11.2 è„šæœ¬ç»“æ„æ€»è§ˆ</h3>
                <p>å®Œæ•´çš„ Runner Script åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š</p>

                <div class="diagram-box">
                    <div class="diagram-title">Runner Script ç»„ä»¶æ¶æ„</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="arch-box">
                            <div class="arch-box-title">IPC åè®®å±‚</div>
                            <ul>
                                <li>åè®®æ ‡è®°å¸¸é‡</li>
                                <li>æ¶ˆæ¯ç¼–è§£ç </li>
                                <li>è¾¹ç•Œæ£€æµ‹</li>
                            </ul>
                        </div>
                        <div class="arch-box host">
                            <div class="arch-box-title">I/O ç®¡ç†å±‚</div>
                            <ul>
                                <li>æ— ç¼“å†²è¯»å–</li>
                                <li>å…±äº«ç¼“å†²åŒº</li>
                                <li>çº¿ç¨‹é”åŒæ­¥</li>
                            </ul>
                        </div>
                        <div class="arch-box">
                            <div class="arch-box-title">å·¥å…·è°ƒç”¨å±‚</div>
                            <ul>
                                <li>åŠ¨æ€å‡½æ•°ç”Ÿæˆ</li>
                                <li>å¼‚æ­¥æ‰§è¡Œå™¨</li>
                                <li>ç»“æœåè°ƒ</li>
                            </ul>
                        </div>
                        <div class="arch-box host">
                            <div class="arch-box-title">ä»£ç æ‰§è¡Œå±‚</div>
                            <ul>
                                <li>ä»£ç åŒ…è£…</li>
                                <li>è¾“å‡ºæ•è·</li>
                                <li>å¼‚å¸¸å¤„ç†</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h3>11.3 å…¨å±€çŠ¶æ€ç®¡ç†</h3>
                <p>Runner Script ä½¿ç”¨å…¨å±€å˜é‡ç®¡ç†å…±äº«çŠ¶æ€ï¼Œæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="comment"># å…±äº«çŠ¶æ€ - ç”¨äºç»“æœåè°ƒï¼ˆä½¿ç”¨æ— ç¼“å†² I/Oï¼‰</span>
<span class="comment"># è¿™é¿å…äº† select() å’Œ Python ç¼“å†² readline() æ··ç”¨çš„é—®é¢˜</span>

_results = {}           <span class="comment"># call_id -> result çš„æ˜ å°„</span>
_io_lock = threading.Lock()  <span class="comment"># I/O æ“ä½œçš„çº¿ç¨‹é”</span>
_stdin_buffer = <span class="string">""</span>      <span class="comment"># æ— ç¼“å†² stdin è¯»å–çš„å…±äº«ç¼“å†²åŒº</span>
_stdin_fd = <span class="keyword">None</span>        <span class="comment"># stdin æ–‡ä»¶æè¿°ç¬¦ï¼ˆç¼“å­˜ï¼‰</span>

<span class="keyword">def</span> <span class="function">_get_stdin_fd</span>():
    <span class="string">"""è·å– stdin æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¸¦ç¼“å­˜ï¼‰"""</span>
    <span class="keyword">global</span> _stdin_fd
    <span class="keyword">if</span> _stdin_fd <span class="keyword">is</span> <span class="keyword">None</span>:
        _stdin_fd = sys.stdin.fileno()
    <span class="keyword">return</span> _stdin_fd</code></pre>
                </div>

                <div class="info-box">
                    <strong>ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€çŠ¶æ€ï¼Ÿ</strong>
                    <p>å½“ç”¨æˆ·ä»£ç ä½¿ç”¨ <code>asyncio.gather()</code> å¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·æ—¶ï¼Œæ¯ä¸ªå·¥å…·è°ƒç”¨åœ¨ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å…±äº«çš„ <code>_results</code> å­—å…¸å…è®¸ä»»æ„çº¿ç¨‹è¯»å–åˆ°å‘å¾€å®ƒçš„ç»“æœï¼Œè€Œ <code>_io_lock</code> ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</p>
                </div>
            </section>

            <section id="unbuffered-io" class="fade-in">
                <h2><span class="section-number">12</span>æ— ç¼“å†² I/O æœºåˆ¶</h2>
                <p>Runner Script çš„æ ¸å¿ƒåˆ›æ–°æ˜¯ä½¿ç”¨<strong>æ— ç¼“å†² I/O</strong> æ›¿ä»£ Python é»˜è®¤çš„ç¼“å†² I/Oï¼Œè¿™è§£å†³äº†å¹¶è¡Œå·¥å…·è°ƒç”¨æ—¶çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚</p>

                <h3>12.1 é—®é¢˜èƒŒæ™¯</h3>
                <p>Python çš„ <code>sys.stdin.readline()</code> ä½¿ç”¨å†…éƒ¨ç¼“å†²åŒºï¼Œä¸ <code>select()</code> é…åˆä½¿ç”¨æ—¶ä¼šå¯¼è‡´é—®é¢˜ï¼š</p>

                <div class="diagram-box">
                    <div class="diagram-title">ç¼“å†² I/O çš„é—®é¢˜</div>
                    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.8;">
<span style="color: var(--accent-rose); font-weight: 600;">é—®é¢˜åœºæ™¯ï¼šå¹¶è¡Œå·¥å…·è°ƒç”¨</span>

çº¿ç¨‹ A (get_expenses)          çº¿ç¨‹ B (get_budget)
        â”‚                              â”‚
        â”œâ”€ readline() é˜»å¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                              â”‚
        â”‚  <span style="color: var(--text-muted);">â† ä¸»è¿›ç¨‹å‘é€ä¸¤ä¸ªç»“æœ â†’</span>      â”‚
        â”‚  result_A + result_B         â”‚
        â”‚                              â”‚
        â”œâ”€ readline() è¯»å– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  è¯»åˆ° result_A               â”‚
        â”‚  <span style="color: var(--accent-rose);">ä½† result_B ç•™åœ¨ç¼“å†²åŒº!</span>    â”‚
        â”‚                              â”‚
        â”‚                              â”œâ”€ readline() é˜»å¡
        â”‚                              â”‚  <span style="color: var(--accent-rose);">æ°¸è¿œç­‰ä¸åˆ°æ•°æ®!</span>
        â”‚                              â”‚  (æ•°æ®åœ¨çº¿ç¨‹Açš„ç¼“å†²åŒº)</pre>
                </div>

                <h3>12.2 è§£å†³æ–¹æ¡ˆï¼šå…±äº«ç¼“å†²åŒº</h3>
                <p>ä½¿ç”¨ <code>os.read()</code> è¿›è¡Œæ— ç¼“å†²è¯»å–ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªåº”ç”¨çº§ç¼“å†²åŒºï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_read_and_buffer_data</span>(timeout: <span class="builtin">float</span> = <span class="number">0.1</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""ä» stdin è¯»å–æ•°æ®åˆ°å…±äº«ç¼“å†²åŒºï¼ˆæ— ç¼“å†² I/Oï¼‰

    å¿…é¡»æŒæœ‰ _io_lock æ‰èƒ½è°ƒç”¨æ­¤å‡½æ•°ã€‚
    è¿”å› True è¡¨ç¤ºè¯»å–åˆ°æ•°æ®ï¼ŒFalse è¡¨ç¤ºæ²¡æœ‰æ•°æ®ã€‚
    """</span>
    <span class="keyword">global</span> _stdin_buffer
    stdin_fd = _get_stdin_fd()

    <span class="keyword">try</span>:
        <span class="comment"># ä½¿ç”¨ select æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»</span>
        readable, _, _ = select.select([stdin_fd], [], [], timeout)
        <span class="keyword">if not</span> readable:
            <span class="keyword">return</span> <span class="keyword">False</span>

        <span class="comment"># æ— ç¼“å†²è¯»å– - ç›´æ¥ä»æ–‡ä»¶æè¿°ç¬¦è¯»å–</span>
        chunk = os.read(stdin_fd, <span class="number">65536</span>)  <span class="comment"># æœ€å¤šè¯»å– 64KB</span>
        <span class="keyword">if not</span> chunk:
            <span class="keyword">return</span> <span class="keyword">False</span>

        <span class="comment"># è¿½åŠ åˆ°å…±äº«ç¼“å†²åŒº</span>
        _stdin_buffer += chunk.decode(<span class="string">"utf-8"</span>)
        <span class="keyword">return</span> <span class="keyword">True</span>
    <span class="keyword">except</span> (OSError, ValueError):
        <span class="keyword">return</span> <span class="keyword">False</span></code></pre>
                </div>

                <h3>12.3 ç»“æœå¤„ç†æµæ°´çº¿</h3>
                <p>è¯»å–æ•°æ®åï¼Œéœ€è¦è§£æå¹¶åˆ†å‘åˆ°å¯¹åº”çš„ç­‰å¾…çº¿ç¨‹ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_process_tool_results</span>():
    <span class="string">"""å¤„ç†ç¼“å†²åŒºä¸­çš„å®Œæ•´å·¥å…·ç»“æœè¡Œ

    å¿…é¡»æŒæœ‰ _io_lock æ‰èƒ½è°ƒç”¨æ­¤å‡½æ•°ã€‚
    """</span>
    <span class="keyword">global</span> _stdin_buffer

    <span class="comment"># é€è¡Œå¤„ç†ç¼“å†²åŒº</span>
    <span class="keyword">while</span> <span class="string">"\\n"</span> <span class="keyword">in</span> _stdin_buffer:
        line, remaining = _stdin_buffer.split(<span class="string">"\\n"</span>, <span class="number">1</span>)

        <span class="comment"># æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·ç»“æœæ¶ˆæ¯</span>
        <span class="keyword">if</span> IPC_TOOL_RESULT_START <span class="keyword">in</span> line <span class="keyword">and</span> IPC_TOOL_RESULT_END <span class="keyword">in</span> line:
            <span class="keyword">try</span>:
                <span class="comment"># æå– JSON å†…å®¹</span>
                start = line.find(IPC_TOOL_RESULT_START) + <span class="builtin">len</span>(IPC_TOOL_RESULT_START)
                end = line.find(IPC_TOOL_RESULT_END)
                result_json = line[start:end]
                result = json.loads(result_json)

                <span class="comment"># å­˜å‚¨åˆ°å…±äº«å­—å…¸ï¼Œä¾›å¯¹åº”çº¿ç¨‹è·å–</span>
                call_id = result.get(<span class="string">"call_id"</span>)
                <span class="keyword">if</span> call_id:
                    _results[call_id] = result  <span class="comment"># å…³é”®ï¼šæŒ‰ call_id åˆ†å‘</span>
            <span class="keyword">except</span> Exception:
                <span class="keyword">pass</span>

            _stdin_buffer = remaining
        <span class="keyword">else</span>:
            <span class="comment"># éå·¥å…·ç»“æœè¡Œï¼Œåœæ­¢å¤„ç†ï¼ˆå¯èƒ½æ˜¯ä»£ç å—ï¼‰</span>
            <span class="keyword">break</span></code></pre>
                </div>

                <div class="diagram-box">
                    <div class="diagram-title">å…±äº«ç¼“å†²åŒºå·¥ä½œæµç¨‹</div>
                    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.8;">
<span style="color: var(--accent-emerald); font-weight: 600;">è§£å†³æ–¹æ¡ˆï¼šå…±äº«ç¼“å†²åŒº + çº¿ç¨‹é”</span>

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           _stdin_buffer (å…±äº«)           â”‚
          â”‚  "result_A\\nresult_B\\n"                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    _io_lock ä¿æŠ¤
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                               â”‚
     çº¿ç¨‹ A                          çº¿ç¨‹ B
          â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ è·å–é”     â”‚                   â”‚ ç­‰å¾…é”     â”‚
    â”‚ è¯»å–æ•°æ®   â”‚                   â”‚    ...    â”‚
    â”‚ å¤„ç†ç»“æœ   â”‚                   â”‚    ...    â”‚
    â”‚ æ‰¾åˆ° A     â”‚ â†â”€ <span style="color: var(--accent-emerald);">result_A</span>     â”‚    ...    â”‚
    â”‚ B å­˜å…¥å­—å…¸ â”‚ â”€â”€â†’ _results["B"]â”‚    ...    â”‚
    â”‚ é‡Šæ”¾é”     â”‚                   â”‚ è·å–é”     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ æ£€æŸ¥å­—å…¸   â”‚
                                    â”‚ æ‰¾åˆ° B     â”‚ â†â”€ <span style="color: var(--accent-blue);">result_B</span>
                                    â”‚ é‡Šæ”¾é”     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                </div>
            </section>

            <section id="parallel-tools" class="fade-in">
                <h2><span class="section-number">13</span>å¹¶è¡Œå·¥å…·è°ƒç”¨</h2>
                <p>Runner Script çš„è®¾è®¡å…è®¸ç”¨æˆ·ä»£ç ä½¿ç”¨ <code>asyncio.gather()</code> å¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·ï¼Œå¤§å¹…æå‡æ‰§è¡Œæ•ˆç‡ã€‚</p>

                <h3>13.1 ç­‰å¾…ç»“æœçš„å®ç°</h3>
                <p>æ¯ä¸ªå·¥å…·è°ƒç”¨åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­ç­‰å¾…ç»“æœï¼Œé€šè¿‡å…±äº«çŠ¶æ€å®ç°åè°ƒï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_receive_tool_result</span>(call_id: <span class="builtin">str</span>, timeout: <span class="builtin">float</span> = <span class="number">300.0</span>) -> Any:
    <span class="string">"""ç­‰å¾…å·¥å…·ç»“æœï¼ˆä½¿ç”¨æ— ç¼“å†² I/O å’Œå…±äº«ç¼“å†²åŒºï¼‰

    æ­¤å‡½æ•°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æ­£ç¡®å¤„ç†å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼š
    1. ä½¿ç”¨æ— ç¼“å†²çš„ os.read() æ›¿ä»£ç¼“å†²çš„ readline()
    2. æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªç¼“å†²åŒº
    3. ç»“æœåˆ°è¾¾æ—¶å­˜å‚¨ï¼Œä¾›å…¶ä»–çº¿ç¨‹è·å–
    """</span>
    start_time = time.time()

    <span class="keyword">while</span> time.time() - start_time < timeout:
        <span class="keyword">with</span> _io_lock:
            <span class="comment"># 1. æ£€æŸ¥ç»“æœæ˜¯å¦å·²ç»å¯ç”¨ï¼ˆå…¶ä»–çº¿ç¨‹å¯èƒ½å·²å¤„ç†ï¼‰</span>
            <span class="keyword">if</span> call_id <span class="keyword">in</span> _results:
                result = _results.pop(call_id)
                <span class="keyword">if</span> result.get(<span class="string">"error"</span>):
                    <span class="keyword">raise</span> RuntimeError(<span class="string">f"Tool error: {result['error']}"</span>)
                <span class="keyword">return</span> result.get(<span class="string">"result"</span>)

            <span class="comment"># 2. å°è¯•è¯»å–æ›´å¤šæ•°æ®å¹¶å¤„ç†</span>
            _read_and_buffer_data(timeout=<span class="number">0.05</span>)
            _process_tool_results()

            <span class="comment"># 3. å¤„ç†åå†æ¬¡æ£€æŸ¥</span>
            <span class="keyword">if</span> call_id <span class="keyword">in</span> _results:
                result = _results.pop(call_id)
                <span class="keyword">if</span> result.get(<span class="string">"error"</span>):
                    <span class="keyword">raise</span> RuntimeError(<span class="string">f"Tool error: {result['error']}"</span>)
                <span class="keyword">return</span> result.get(<span class="string">"result"</span>)

        <span class="comment"># 4. é”å¤–çŸ­æš‚ä¼‘çœ ï¼Œè®©å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œ</span>
        time.sleep(<span class="number">0.01</span>)

    <span class="keyword">raise</span> TimeoutError(<span class="string">f"Timeout waiting for tool result: {call_id}"</span>)</code></pre>
                </div>

                <h3>13.2 å¼‚æ­¥å·¥å…·å‡½æ•°ç”Ÿæˆ</h3>
                <p>æ¯ä¸ªå·¥å…·å‡½æ•°æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œä½¿ç”¨ <code>run_in_executor</code> åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œé˜»å¡çš„ I/O æ“ä½œï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">_create_tool_function</span>(tool_name: <span class="builtin">str</span>):
    <span class="string">"""åˆ›å»ºå¼‚æ­¥å·¥å…·å‡½æ•°ï¼ˆè°ƒç”¨å¤–éƒ¨ä¸»è¿›ç¨‹æ‰§è¡Œï¼‰"""</span>
    <span class="keyword">async def</span> <span class="function">tool_func</span>(**kwargs) -> Any:
        <span class="comment"># 1. å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚åˆ°ä¸»è¿›ç¨‹ï¼ˆé€šè¿‡ stderrï¼‰</span>
        call_id = _send_tool_call(tool_name, kwargs)

        <span class="comment"># 2. åœ¨çº¿ç¨‹æ± ä¸­ç­‰å¾…ç»“æœ</span>
        <span class="comment">#    - é¿å…é˜»å¡ asyncio äº‹ä»¶å¾ªç¯</span>
        <span class="comment">#    - å…è®¸å…¶ä»–å·¥å…·è°ƒç”¨å¹¶è¡Œæ‰§è¡Œ</span>
        loop = asyncio.get_event_loop()
        result = <span class="keyword">await</span> loop.run_in_executor(
            <span class="keyword">None</span>,  <span class="comment"># ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± </span>
            <span class="keyword">lambda</span>: _receive_tool_result(call_id)
        )
        <span class="keyword">return</span> result

    <span class="keyword">return</span> tool_func

<span class="comment"># åŠ¨æ€åˆ›å»ºæ‰€æœ‰å·¥å…·å‡½æ•°</span>
_tool_functions = {}
<span class="keyword">for</span> tool_info <span class="keyword">in</span> TOOLS_INFO:
    tool_name = tool_info[<span class="string">"name"</span>]
    _tool_functions[tool_name] = _create_tool_function(tool_name)</code></pre>
                </div>

                <h3>13.3 å¹¶è¡Œè°ƒç”¨ç¤ºä¾‹</h3>
                <p>ç”¨æˆ·å¯ä»¥ç¼–å†™è¿™æ ·çš„ä»£ç æ¥å¹¶è¡Œè°ƒç”¨å·¥å…·ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python - ç”¨æˆ·ä»£ç ç¤ºä¾‹</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="comment"># å¹¶è¡Œè·å–å¤šä¸ªå‘˜å·¥çš„è´¹ç”¨æ•°æ®</span>
employee_ids = [<span class="string">"ENG001"</span>, <span class="string">"ENG002"</span>, <span class="string">"ENG003"</span>, <span class="string">"ENG004"</span>]

<span class="comment"># åˆ›å»ºå¹¶è¡Œä»»åŠ¡</span>
expense_tasks = [
    get_expenses(employee_id=emp_id, quarter=<span class="string">"Q3"</span>)
    <span class="keyword">for</span> emp_id <span class="keyword">in</span> employee_ids
]

<span class="comment"># å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ - 4ä¸ªè¯·æ±‚åŒæ—¶å‘å‡º!</span>
results = <span class="keyword">await</span> asyncio.gather(*expense_tasks)

<span class="comment"># å¤„ç†ç»“æœ</span>
<span class="keyword">for</span> emp_id, result <span class="keyword">in</span> <span class="builtin">zip</span>(employee_ids, results):
    <span class="builtin">print</span>(<span class="string">f"{emp_id}: {result}"</span>)</code></pre>
                </div>

                <div class="info-box">
                    <strong>æ€§èƒ½ä¼˜åŠ¿</strong>
                    <p>å¹¶è¡Œè°ƒç”¨ 4 ä¸ªå·¥å…·çš„æ—¶é—´çº¦ç­‰äºæœ€æ…¢é‚£ä¸ªå·¥å…·çš„æ‰§è¡Œæ—¶é—´ï¼Œè€Œé 4 ä¸ªå·¥å…·æ‰§è¡Œæ—¶é—´ä¹‹å’Œã€‚ä¸»è¿›ç¨‹ä¼šæ‰¹é‡æ”¶é›†è¿™äº›è¯·æ±‚å¹¶è¿”å›ç»™å®¢æˆ·ç«¯å¹¶è¡Œæ‰§è¡Œã€‚</p>
                </div>
            </section>

            <section id="execution-modes" class="fade-in">
                <h2><span class="section-number">14</span>æ‰§è¡Œæ¨¡å¼</h2>
                <p>Runner Script æ”¯æŒä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼š<strong>å•æ¬¡æ‰§è¡Œæ¨¡å¼</strong>å’Œ<strong>å¾ªç¯æ‰§è¡Œæ¨¡å¼</strong>ï¼Œé€šè¿‡ <code>LOOP_MODE</code> å˜é‡æ§åˆ¶ã€‚</p>

                <h3>14.1 å•æ¬¡æ‰§è¡Œæ¨¡å¼ (Single Mode)</h3>
                <p>æ‰§è¡Œä¸€æ¬¡ä»£ç åé€€å‡ºï¼Œé€‚ç”¨äºæ— çŠ¶æ€çš„ç®€å•åœºæ™¯ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">main_single</span>():
    <span class="string">"""å•æ¬¡æ‰§è¡Œæ¨¡å¼"""</span>
    <span class="comment"># 1. è¯»å–ä»£ç å—</span>
    code = read_code_block()

    <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or not</span> code:
        error_result = json.dumps({<span class="string">"success"</span>: <span class="keyword">False</span>, <span class="string">"output"</span>: <span class="string">""</span>, <span class="string">"error"</span>: <span class="string">"No code provided"</span>})
        <span class="builtin">print</span>(<span class="string">f"{IPC_CODE_OUTPUT_START}{error_result}{IPC_CODE_OUTPUT_END}"</span>, flush=<span class="keyword">True</span>)
        <span class="keyword">return</span>

    <span class="comment"># 2. å‡†å¤‡æ‰§è¡Œç¯å¢ƒ</span>
    exec_globals = {
        <span class="string">"__builtins__"</span>: __builtins__,
        <span class="string">"asyncio"</span>: asyncio,
        <span class="string">"json"</span>: json,
    }

    <span class="comment"># 3. æ‰§è¡Œä»£ç </span>
    <span class="keyword">try</span>:
        result = asyncio.run(execute_user_code(code, exec_globals))
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        result = {<span class="string">"success"</span>: <span class="keyword">False</span>, <span class="string">"output"</span>: <span class="string">""</span>, <span class="string">"error"</span>: <span class="builtin">str</span>(e)}

    <span class="comment"># 4. è¾“å‡ºç»“æœå¹¶é€€å‡º</span>
    <span class="builtin">print</span>(<span class="string">f"{IPC_CODE_OUTPUT_START}{json.dumps(result)}{IPC_CODE_OUTPUT_END}"</span>, flush=<span class="keyword">True</span>)</code></pre>
                </div>

                <h3>14.2 å¾ªç¯æ‰§è¡Œæ¨¡å¼ (Loop Mode)</h3>
                <p>å®¹å™¨ä¿æŒè¿è¡Œï¼Œå¯æ‰§è¡Œå¤šæ®µä»£ç ï¼Œæ”¯æŒ<strong>ä¼šè¯å¤ç”¨</strong>å’Œ<strong>çŠ¶æ€ä¿æŒ</strong>ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">main_loop</span>():
    <span class="string">"""å¾ªç¯æ‰§è¡Œæ¨¡å¼ - ç”¨äºä¼šè¯å¤ç”¨"""</span>
    <span class="comment"># 1. å‡†å¤‡å…±äº«çš„æ‰§è¡Œç¯å¢ƒï¼ˆè·¨æ‰§è¡Œä¿æŒçŠ¶æ€ï¼‰</span>
    exec_globals = {
        <span class="string">"__builtins__"</span>: __builtins__,
        <span class="string">"asyncio"</span>: asyncio,
        <span class="string">"json"</span>: json,
    }

    <span class="comment"># 2. å‘é€å°±ç»ªä¿¡å·</span>
    <span class="builtin">print</span>(<span class="string">f"{READY_SIGNAL}"</span>, file=sys.stderr, flush=<span class="keyword">True</span>)

    <span class="comment"># 3. è¿›å…¥ä¸»å¾ªç¯</span>
    <span class="keyword">while</span> <span class="keyword">True</span>:
        code = read_code_block()

        <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># æ”¶åˆ°é€€å‡ºä¿¡å·æˆ– EOF</span>
            <span class="keyword">break</span>

        <span class="keyword">if not</span> code:
            error_result = json.dumps({<span class="string">"success"</span>: <span class="keyword">False</span>, <span class="string">"output"</span>: <span class="string">""</span>, <span class="string">"error"</span>: <span class="string">"No code provided"</span>})
            <span class="builtin">print</span>(<span class="string">f"{IPC_CODE_OUTPUT_START}{error_result}{IPC_CODE_OUTPUT_END}"</span>, flush=<span class="keyword">True</span>)
            <span class="keyword">continue</span>

        <span class="comment"># æ‰§è¡Œä»£ç ï¼ˆexec_globals åœ¨å¤šæ¬¡æ‰§è¡Œé—´å…±äº«ï¼‰</span>
        <span class="keyword">try</span>:
            result = asyncio.run(execute_user_code(code, exec_globals))
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            result = {<span class="string">"success"</span>: <span class="keyword">False</span>, <span class="string">"output"</span>: <span class="string">""</span>, <span class="string">"error"</span>: <span class="builtin">str</span>(e)}

        <span class="builtin">print</span>(<span class="string">f"{IPC_CODE_OUTPUT_START}{json.dumps(result)}{IPC_CODE_OUTPUT_END}"</span>, flush=<span class="keyword">True</span>)</code></pre>
                </div>

                <h3>14.3 æ¨¡å¼å¯¹æ¯”</h3>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ç‰¹æ€§</th>
                                <th>å•æ¬¡æ¨¡å¼</th>
                                <th>å¾ªç¯æ¨¡å¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>å®¹å™¨ç”Ÿå‘½å‘¨æœŸ</td>
                                <td>æ‰§è¡Œä¸€æ¬¡åé”€æ¯</td>
                                <td>ä¿æŒè¿è¡Œï¼Œå¯å¤ç”¨</td>
                            </tr>
                            <tr>
                                <td>çŠ¶æ€ä¿æŒ</td>
                                <td>æ— çŠ¶æ€</td>
                                <td>å˜é‡è·¨æ‰§è¡Œä¿æŒ</td>
                            </tr>
                            <tr>
                                <td>å¯åŠ¨å¼€é”€</td>
                                <td>æ¯æ¬¡æ‰§è¡Œéƒ½æœ‰</td>
                                <td>ä»…é¦–æ¬¡å¯åŠ¨</td>
                            </tr>
                            <tr>
                                <td>å°±ç»ªä¿¡å·</td>
                                <td>ä¸å‘é€</td>
                                <td>å‘é€ <code>__READY__</code></td>
                            </tr>
                            <tr>
                                <td>é€€å‡ºæ–¹å¼</td>
                                <td>æ‰§è¡Œå®Œè‡ªåŠ¨é€€å‡º</td>
                                <td>æ”¶åˆ° <code>__EXIT_SESSION__</code> æˆ–è¶…æ—¶</td>
                            </tr>
                            <tr>
                                <td>é€‚ç”¨åœºæ™¯</td>
                                <td>ç®€å•ã€ä¸€æ¬¡æ€§ä»»åŠ¡</td>
                                <td>å¤šè½®å¯¹è¯ã€å¤æ‚å·¥ä½œæµ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3>14.4 ä¸»å…¥å£åˆ†å‘</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">main</span>():
    <span class="string">"""ä¸»å…¥å£ - æ ¹æ®é…ç½®é€‰æ‹©æ‰§è¡Œæ¨¡å¼"""</span>
    <span class="keyword">if</span> LOOP_MODE:
        main_loop()   <span class="comment"># å¾ªç¯æ¨¡å¼ï¼šä¼šè¯å¤ç”¨</span>
    <span class="keyword">else</span>:
        main_single() <span class="comment"># å•æ¬¡æ¨¡å¼ï¼šæ‰§è¡Œå³é€€å‡º</span>

<span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:
    main()</code></pre>
                </div>

                <div class="info-box warning">
                    <strong>ä¼šè¯è¶…æ—¶</strong>
                    <p>å¾ªç¯æ¨¡å¼ä¸‹ï¼Œä¼šè¯é»˜è®¤åœ¨ 4.5 åˆ†é’Ÿåè¶…æ—¶ï¼ˆä¸ Anthropic API ä¸€è‡´ï¼‰ã€‚ä¸»è¿›ç¨‹ä¼šå‘é€ <code>__EXIT_SESSION__</code> ä¿¡å·æˆ–ç›´æ¥å…³é—­å®¹å™¨æ¥ç»ˆæ­¢ä¼šè¯ã€‚</p>
                </div>
            </section>

            <section id="template" class="fade-in">
                <h2><span class="section-number">15</span>æ¨¡æ¿å˜é‡è¯´æ˜</h2>
                <p>Runner è„šæœ¬æ˜¯ä¸€ä¸ª<strong>æ¨¡æ¿æ–‡ä»¶</strong>ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä¸»è¿›ç¨‹ä¼šå°† <code>{tools_info}</code> å ä½ç¬¦æ›¿æ¢ä¸ºçœŸæ­£çš„å·¥å…·å®šä¹‰ï¼š</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code><span class="comment"># æ¨¡æ¿ä¸­çš„å ä½ç¬¦</span>
<span class="variable">TOOLS_INFO</span> = {tools_info}

<span class="comment"># å®é™…è¿è¡Œæ—¶ä¼šè¢«æ›¿æ¢ä¸ºï¼š</span>
<span class="variable">TOOLS_INFO</span> = [
    {<span class="string">"name"</span>: <span class="string">"web_search"</span>, <span class="string">"description"</span>: <span class="string">"æœç´¢ç½‘é¡µ"</span>},
    {<span class="string">"name"</span>: <span class="string">"read_file"</span>, <span class="string">"description"</span>: <span class="string">"è¯»å–æ–‡ä»¶"</span>},
    {<span class="string">"name"</span>: <span class="string">"query_database"</span>, <span class="string">"description"</span>: <span class="string">"æŸ¥è¯¢æ•°æ®åº“"</span>}
]</code></pre>
                </div>
            </section>
        </article>
    </div>

    <footer>
        <p>Anthropic API Proxy Â· Sandbox Runner Documentation</p>
        <p>Built with <span style="color: var(--accent-rose);">â™¥</span> for secure code execution</p>
    </footer>

    <script>
        // Initialize Mermaid with light theme
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#eef2ff',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#6366f1',
                lineColor: '#94a3b8',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#f1f5f9',
                noteBkgColor: '#faf5ff',
                noteTextColor: '#475569',
                actorBkg: '#f8fafc',
                actorBorder: '#6366f1',
                actorTextColor: '#0f172a',
                actorLineColor: '#94a3b8',
                signalColor: '#475569',
                signalTextColor: '#0f172a',
                sequenceNumberColor: '#fefefe'
            },
            sequence: {
                actorMargin: 50,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: false,
                useMaxWidth: true
            }
        });

        // Copy code functionality
        function copyCode(button) {
            const codeBlock = button.closest('.code-block').querySelector('code');
            const text = codeBlock.textContent;

            navigator.clipboard.writeText(text).then(() => {
                button.textContent = 'å·²å¤åˆ¶!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶ä»£ç ';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Scroll-based TOC highlighting
        const sections = document.querySelectorAll('section[id]');
        const tocItems = document.querySelectorAll('.toc-item');

        function highlightToc() {
            let current = '';

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;

                if (window.scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            tocItems.forEach(item => {
                item.classList.remove('active');
                if (item.querySelector('a').getAttribute('href') === `#${current}`) {
                    item.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', highlightToc);
        highlightToc();

        // Fade in animation on scroll
        const fadeElements = document.querySelectorAll('.fade-in');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });

        fadeElements.forEach(el => observer.observe(el));

        // Add visible class to elements already in view on load
        window.addEventListener('load', () => {
            fadeElements.forEach(el => {
                const rect = el.getBoundingClientRect();
                if (rect.top < window.innerHeight) {
                    el.classList.add('visible');
                }
            });
        });
    </script>
</body>
</html>
